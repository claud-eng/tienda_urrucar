{% extends 'base.html' %}
{% load static %}
{% block title %}
{% if user.empleado and user.empleado.rol == 'Administrador' %}
        Historial de Ventas Online
    {% else %}
        Historial de Compras Online
    {% endif %}
{% endblock %}
{% block content %}

<style>
    .table td, .table th {
        vertical-align: middle;
        text-align: center;
    }
</style>

<div class="container mt-4">
    <h2>
        {% if user.empleado and user.empleado.rol == 'Administrador' %}
            Historial de Ventas Online
        {% else %}
            Historial de Compras Online
        {% endif %}
    </h2>

    {% if user.empleado and user.empleado.rol == 'Administrador' %}
    <!-- Formulario de búsqueda -->
    <form method="GET" class="form-control-file mb-2">
        <div class="form-group">
            <label for="search-cliente">Buscar por Cliente:</label>
            <input type="text" class="form-control mx-2" id="search-cliente" name="cliente" placeholder="Nombre del Cliente" value="{{ cliente_query }}">
        </div>
        <button type="submit" class="btn btn-outline-primary btn-sm mb-2">Filtrar</button>
        <a href="{% url 'listar_ventas_online' %}" class="btn btn-outline-danger btn-sm mb-2">Quitar filtro</a>
    </form>
    {% endif %}

<!-- Tabla de ventas online -->
<div class="table-responsive mb-4"> <!-- Añadido mb-4 para espacio entre tabla y paginación -->
    <table class="table table-hover">
        <thead class="thead-dark">
            <tr>
                <th>Número de Orden</th>
                <th>Cliente</th>
                <th>Correo</th>
                <th>¿Usuario registrado?</th>   
                <th>Fecha</th>
                <th>Detalle</th>
                <th>Tipo de Pago</th>
                <th>Monto de Cuotas</th>
                <th>Número de Cuotas</th>
                <th>Total (IVA incluido)</th>
                <th>Emitir Comprobante</th>
                {% if user.is_authenticated and user.empleado and user.empleado.rol == 'Administrador' %}
                    <th>Estado</th>
                    <th>Acciones</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for orden in ordenes_paginadas %}
            <tr class="{% cycle 'table-light' 'table-secondary' %}">
                <td>{{ orden.numero_orden }}</td>
                
                <td>
                    {% if orden.cliente %}
                        {{ orden.cliente.user.first_name }} {{ orden.cliente.user.last_name }}
                    {% elif orden.cliente_anonimo %}
                        {{ orden.cliente_anonimo.nombre }} {{ orden.cliente_anonimo.apellido }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
        
                <td>
                    {% if orden.cliente %}
                        {{ orden.cliente.user.email }}
                    {% elif orden.cliente_anonimo %}
                        {{ orden.cliente_anonimo.email }}
                    {% else %}
                        N/A
                    {% endif %}
                </td>

                <td>
                    {% if orden.cliente %}
                        Sí
                    {% elif orden.cliente_anonimo %}
                        No
                    {% else %}
                        N/A
                    {% endif %}
                </td>

                <td>{{ orden.fecha|date:"d/m/Y H:i" }}</td>
                
                <td>
                    {% for detalle in orden.detalles_formateados %}
                        {% if detalle.es_producto %}
                            {{ detalle.nombre }} - Cantidad: {{ detalle.cantidad }} - Precio: ${{ detalle.precio_formateado }}<br>
                        {% else %}
                            {{ detalle.nombre }} - Valor: ${{ detalle.precio_formateado }}<br>
                        {% endif %}
                    {% endfor %}
                </td>
        
                <td>
                    {% if orden.tipo_pago == 'VD' %}
                        Venta Débito
                    {% elif orden.tipo_pago == 'VN' %}
                        Venta Normal
                    {% elif orden.tipo_pago == 'VC' %}
                        Venta en Cuotas
                    {% elif orden.tipo_pago == 'SI' %}
                        3 Cuotas sin Interés
                    {% elif orden.tipo_pago == 'S2' %}
                        2 Cuotas sin Interés
                    {% elif orden.tipo_pago == 'NC' %}
                        Cuotas sin Interés
                    {% elif orden.tipo_pago == 'VP' %}
                        Venta Prepago
                    {% else %}
                        {{ orden.tipo_pago }}
                    {% endif %}
                </td>
        
                <td>${{ orden.monto_cuotas|default:'0' }}</td>
                <td>{{ orden.numero_cuotas }}</td>
                <td>${{ orden.total_formateado }}</td>
                <td>
                    <a href="{% url 'descargar_comprobante_pago' 'online' orden.numero_orden %}" class="btn btn-success btn-sm">Descargar</a>
                </td>
        
                {% if user.is_authenticated and user.empleado and user.empleado.rol == 'Administrador' %}
                <td>
                    {% for detalle in orden.detalleventaonline_set.all %}
                        {% if detalle.producto and detalle.producto.categoria == "Vehículo" %}
                            {% if detalle.estado_reserva %}
                                {{ detalle.estado_reserva }}
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </td>
                <td>
                    <a href="{% url 'editar_venta_online' orden.id %}" class="btn btn-primary btn-sm">Editar</a>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>        
    </table>
</div>

<!-- Paginación con espacio superior -->
<div class="mb-4">
    <nav aria-label="Paginación">
        <ul class="pagination">
            {% if ordenes_paginadas.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% if cliente_query %}&cliente={{ cliente_query }}{% endif %}">Primera</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ ordenes_paginadas.previous_page_number }}{% if cliente_query %}&cliente={{ cliente_query }}{% endif %}">Anterior</a>
                </li>
            {% endif %}
            
            {% for num in ordenes_paginadas.paginator.page_range %}
                <li class="page-item{% if ordenes_paginadas.number == num %} active{% endif %}">
                    <a class="page-link" href="?page={{ num }}{% if cliente_query %}&cliente={{ cliente_query }}{% endif %}">{{ num }}</a>
                </li>
            {% endfor %}
            
            {% if ordenes_paginadas.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ ordenes_paginadas.next_page_number }}{% if cliente_query %}&cliente={{ cliente_query }}{% endif %}">Siguiente</a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ ordenes_paginadas.paginator.num_pages }}{% if cliente_query %}&cliente={{ cliente_query }}{% endif %}">Última</a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>

<div class="mt-4">
    <a href="{% url 'gestionar_transacciones' %}" class="btn btn-danger btn-sm">Volver al menú principal</a>
</div>
    
</div>

{% endblock %}
